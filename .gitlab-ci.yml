stages:
  - build
  - deploy

variables:
  # This tag is generated dynamically. Do not set ECR_REPOSITORY_URI as a variable in the file itself.
  # Ensure ECR_REPOSITORY_URI is set in your GitLab CI/CD Settings (UI).
  DOCKER_IMAGE_TAGGED: $ECR_REPOSITORY_URI:$CI_COMMIT_SHORT_SHA 

# --- STAGE 1: BUILD & PUSH (AWS ECR) ---
build_image:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  
  before_script:
    # 1. Install AWS CLI
    - apk add --no-cache python3 py3-pip
    - pip install awscli --break-system-packages
    # 2. Log in to ECR
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI
  
  script:
    - docker build -t $DOCKER_IMAGE_TAGGED -f serve/Dockerfile .
    - docker push $DOCKER_IMAGE_TAGGED

# --- STAGE 2: DEPLOY (AWS EKS) ---
deploy_k8s:
  stage: deploy
  image: 
    name: docker:24.0.5
    entrypoint: [""]
  
  script:
    # 1. Install Basic Tools (Python, pip, curl)
    # We REMOVED 'kubectl' from here because it caused the error
    - apk add --no-cache python3 py3-pip curl
    
    # 2. Install AWS CLI
    - pip install awscli --break-system-packages
    
    # 3. Install kubectl MANUALLY (The Fix)
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
    
    # 4. Configure connection to your Oregon Cluster
    - aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_DEFAULT_REGION
    
    # 5. Create the Google Key Secret
    - kubectl create secret generic google-credentials --from-file=key.json=$GCP_KEY_FILE --dry-run=client -o yaml | kubectl apply -f -
    
    # 6. Inject the new Image Tag into k8s.yaml
    - sed -i "s|IMAGE_PLACEHOLDER|$DOCKER_IMAGE_TAGGED|g" k8s.yaml
    
    # 7. Apply the Deployment
    - kubectl apply -f k8s.yaml
    
    # 8. Force Restart to make sure the pods update
    - kubectl rollout restart deployment/deforestation-inference
  only:
    - main